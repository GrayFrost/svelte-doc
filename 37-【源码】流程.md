TODO: 直接使用svelte源码来编译自定义的App.svelte，查看具体的编译流程，及各个节点的数据内容

首先下载源码
```
svelte-kit sync
```

```
pnpm add --force @img/sharp-darwin-arm64
```

参照svelte-loader中的逻辑`https://github.com/sveltejs/svelte-loader/blob/master/index.js`
```
svelte.preprocess(source, options.preprocess).then(processed => {
		if (processed.dependencies && this.addDependency) {
			for (let dependency of processed.dependencies) {
				this.addDependency(dependency);
			}
		}

		if (processed.map) compileOptions.sourcemap = processed.map;

		const compiled = svelte.compile(processed.toString(), compileOptions);
		let { js, css, warnings } = compiled;

    callback(null, js.code, js.map);
})
```
首先svelte文件经过预处理，比如像要添加typescript支持等，然后调用compile，最后返回js.code


为了简单直观地查看到各个阶段的执行结果，我们在网站首页直接引入svelte编译器文件

```diff
	import '@sveltejs/site-kit/styles/index.css';

	import { browser } from '$app/environment';
	import { page } from '$app/stores';
	import { Icon, Shell, Banners } from '@sveltejs/site-kit/components';
	import { Nav, Separator } from '@sveltejs/site-kit/nav';
	import { Search, SearchBox } from '@sveltejs/site-kit/search';
+	import { compile, preprocess } from '../../../../packages/svelte/src/compiler';
```

```
let str = `<script>
		let count = 0;
		const addCount = () => {
			count++;
		}
	<\/script>
	
	<button on:click={addCount}>add</button>
	count:{count}
	`;
	preprocess(str, {}).then(preResult => {
		let result = compile(str);
		console.log('zzh compile', preResult, result);
	});
```
结合chrome浏览器断点调试

## compile阶段

![](./img/37-1.png)
## runtime

![](./img/37-2.png)


## 小结