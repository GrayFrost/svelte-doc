## compile阶段

路径：packages/svelte/src/compiler/compile/index.js

```
export default function compile(source, options = {}) {
  const ast = parse(source, options);
  const component = new Component(
		ast,
		source,
		options.name || get_name_from_filename(options.filename) || 'Component',
		options,
		stats,
		warnings
	);
  const result = render_dom(component, options);
  return component.generate(result);
}
```

### parse方法

路径：packages/svelte/src/compiler/parse/index.js

```
export default function parse(template, options = {}) {
	const parser = new Parser(template, options);
  return {
		html: parser.html,
		css: parser.css[0],
		instance: instance_scripts[0],
		module: module_scripts[0]
	};
}
```

#### Parser

### Component

路径：packages/svelte/src/compiler/compile/Component.js

```
this.walk_module_js();
this.walk_instance_js_pre_template();
this.fragment = new Fragment(this, ast.html);
this.walk_instance_js_post_template();
```

this.vars记录变量
walk_module_js找出在script context='module'中的变量

### render_dom

路径：packages/svelte/src/compiler/compile/render_dom/index.js

```
export default function dom(component, options) {
  const renderer = new Renderer(component, options);
}
```

#### Renderer

调用component中的generate方法

## runtime阶段

new App()
->
App extends SvelteComponent
->
SvelteComponent中的constructor中调用名为init的函数
->
init方法中会调用create_fragment
->
create_fragment中是由compiler生成的关于一个组件如何创建更新卸载的生命周期函数

### SvelteComponent

路径：packages/svelte/src/runtime/internal/Component.js

关键属性 `$$`

https://svelte.dev/docs/client-side-component-api

### init

路径：packages/svelte/src/runtime/internal/Component.js

```
function init(
	component,
	options,
	instance,
	create_fragment,
	not_equal,
	props,
	append_styles = null,
	dirty = [-1]
) {}
```

往component示例的 `$$`属性上挂载数据，形成一个context上下文，整个组件的行为都被记录在里面

```
const $$ = (component.$$ = {})
```



`$$.instance` ? todo 待定

首先执行一次 `$$.update`，因为执行了一次
执行所有的`$$.before_update`

判断`$$.fragment`是有有值，`$$.fragment`则是由compile生成的create_fragment方法返回的组件fragment生命周期，如果`$$.fragment`有值，则调用里面的c方法，即fragment的创建。

mount_component挂载组件到页面target上
调用flush()

#### mount_component

调用create_fragment生命周期里的m方法
执行`$$.after_update`里的回调

#### flush

路径：packages/svelte/src/runtime/internal/scheduler.js

一言蔽之，就是把需要更新的组件给更新了

```
function update($$) {
	if ($$.fragment !== null) {
		$$.update();
		run_all($$.before_update);
		const dirty = $$.dirty;
		$$.dirty = [-1];
		$$.fragment && $$.fragment.p($$.ctx, dirty);
		$$.after_update.forEach(add_render_callback);
	}
}
```

调用 `$$.update`,调用组件里的

`$$.fragment.p`方法，执行`$$.after_update`的回调
